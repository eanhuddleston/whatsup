<div id="map" style="width: 600px; height: 400px;"></div>

<script src="http://maps.google.com/maps/api/js?sensor=false&callback=initialize&v=3" 
    type="text/javascript"></script>

<script type="text/javascript">
function initialize() {
  window.events = <%= @events.to_json.html_safe %>

  var locations = []
  for (i = 0; i < events.length; i++) {
    locations[i] = [events[i]['title'], events[i]['latitude'], 
        events[i]['longitude']];
  }

  var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 1,
    center: new google.maps.LatLng(-33.92, 151.25),
    mapTypeId: google.maps.MapTypeId.ROADMAP
  });

  var infoWindow = new google.maps.InfoWindow();
  var bounds = new google.maps.LatLngBounds();

  for (var i = 0; i < locations.length; i++) { 
    var marker = new google.maps.Marker({
      position: new google.maps.LatLng(locations[i][1], locations[i][2]),
      map: map
    });

    var myLatLng = new google.maps.LatLng(locations[i][1], locations[i][2]);
    bounds.extend(myLatLng);
    map.fitBounds(bounds);

    google.maps.event.addListener(marker, 'click', (function(marker, i) {
      return function() {
        infoWindow.setContent(locations[i][0]);
        infoWindow.open(map, marker);
      }
    })(marker, i));
  }
}
</script>

<h3>Events within <%= @distance %> miles</h3>

<%= form_tag home_url, :method => :get do %>
  <p>
    <%= text_field_tag :distance %>
    <%= submit_tag "Change Distance" %>
  </p>
<% end %>

<ul>
<% @events.each do |event| %>
  <li><%= link_to event.title, event %> (<%= event.distance.round(2) %> miles)</li>
<% end %>
</ul>
<br>
<%= link_to "Add Event", new_event_url %>
<br>
<%= link_to "All Events", events_url %>
